<style>
    html, body, #map {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
    }

    .form {
        width: 300px;
    }

    .form .field {
        width: 100%;
        margin-bottom: 10px;
    }

    .form .field input,
    .form .field textarea {
        width: 100%;
        box-sizing: border-box;
    }

    .form .field textarea {
        resize: none;
    }
    .form .review-list {
        max-height: 400px;
        overflow: scroll;
    }
</style>

<div id="map"></div>

<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
<script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>

<script>
let storage = localStorage;
let getData = () => { 
    return JSON.parse(storage.reviews || '{}');
};

ymaps.ready(function () {  
    const map = new ymaps.Map("map", {
        center: [55.793617576635015,49.11371041015617],
        zoom: 12,
    });   
    let data = getData();
    const getReviewsByCoords = (coords) => {
        return data[`${coords[0]},${coords[1]}`] || [];
    }
    const getBalloon = (coords) => {
        const form = createForm(coords, getReviewsByCoords(coords));
        map.balloon.open(coords, form.innerHTML);
    }

    let customItemContentLayout = ymaps.templateLayoutFactory.createClass(
        `<h2 class=ballon_header><a id="openBalloon" data-coords="[{{properties.coords}}]" href="#">{{ properties.place|raw }}</a></h2>
            <div class=ballon_body>{{ properties.name|raw }}</div>
            <div class=ballon_footer>{{ properties.review|raw }}</div>`         
    );
    let clusterer = new ymaps.Clusterer({   
        groupByCoordinates: false,
        clusterDisableClickZoom: true,
        clusterOpenBalloonOnClick: true,
        clusterBalloonContentLayout: 'cluster#balloonCarousel',
        clusterBalloonItemContentLayout: customItemContentLayout,       
    }); 
    map.geoObjects.add(clusterer);      

    const createPlacemark = (coords, settings = {}) => {
        settings.coords = coords;
        const placemark = new ymaps.Placemark(coords, settings);
        placemark.events.add('click', (e) => {
            const coords = e.get('target').geometry.getCoordinates();
            getBalloon(coords);
        });
        clusterer.add(placemark);            
        // map.geoObjects.add(placemark);
    };

    for (let item in data) {
        for (let i = 0; i < data[item].length; i++) {
            createPlacemark(item.split(','),data[item][i]);
        }            
    }

    map.events.add('click', (e) => {
            const coords = e.get('coords');
            getBalloon(coords);
        }
    );

    clusterer.events.add('click', (e) => {
        const coords = e.get('target').geometry.getCoordinates();
        getBalloon(coords);
    });        

    document.body.addEventListener('click', (e) => {
        if (e.target.id === 'addReview') {
            const addForm = document.querySelector('#addForm');
            const coords = JSON.parse(addForm.dataset.coords);
            if(setStorage(coords)) {
                data = getData();
                createPlacemark(coords);
                map.balloon.close();
            }            
        } else if(e.target.id === "openBalloon") {
            e.preventDefault();
            const coords = JSON.parse(e.target.dataset.coords);
            getBalloon(coords);
        }
    });
});
const getFormTemplate = () => {
    const template  = document.querySelector("#reviewsForm").innerHTML;
    const reviewsForm = Handlebars.compile(template);
    return reviewsForm;
}  
// console.log(getFormTemplate()); 
const setStorage = (coords) => {
    const nameReview = document.querySelector('#name').value;
    const placeReview = document.querySelector('#place').value;
    const textReview = document.querySelector('#review').value;

    if(nameReview == '' || placeReview == '' || textReview == '') {
        alert('Все поля должны быть заполнены');
        return false;
    }

    let data = JSON.parse(storage.reviews || '{}');
    let reviewObj = {
        name: nameReview,
        place: placeReview,
        review: textReview
    };
    let i = `${coords[0]},${coords[1]}`;

    data[i] = data[i] || [];
    data[i].push(reviewObj);

    storage.setItem('reviews',JSON.stringify(data));
};

function createForm(coords, reviews) {
    const container = document.createElement('div');
    const template = getFormTemplate();
    container.innerHTML = template();
    const reviewList = container.querySelector('#reviews');
    const reviewForm = container.querySelector('#addForm');
    reviewForm.dataset.coords = JSON.stringify(coords);

    for (const item in reviews) {
        const element = reviews[item];

        const div = document.createElement('div');
        div.classList.add('review-item');
        div.innerHTML = `
        <div>
        <b>${element.name}</b> [${element.place}]
        </div>
        <div>${element.review}</div>
        `;
        reviewList.appendChild(div);      
    }

    return container;
}

</script>
<script id="reviewsForm" type="text/x-handlebars-template">
    <div id="reviews"></div>
    <div id="addForm">
        <h3>Отзыв:</h3>
        <p class="field">
            <input id="name" type="text" placeholder="Укажите ваше имя">
        </p>
        <p class="field">
            <input id="place" type="text" placeholder="Укажите место">
        </p>
        <p class="field">
            <textarea id="review" placeholder="Оставьте отзыв" rows="5"></textarea>
        </p>

        <button id="addReview">Добавить</button>
    </div>
</script>
